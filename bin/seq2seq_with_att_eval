#!/bin/bash

# Evaluate model in test set using beam search and bleu

export MODEL_DIR=$(pwd)/tmp
export DEV_SOURCES=redistribute/QG/test/dev.txt.shuffle.test.source.txt
export DEV_TARGETS_REF=redistribute/QG/test/dev.txt.shuffle.test.target.txt
export PRED_DIR=$(pwd)/pred

python -m bin.infer \
  --tasks "
    - class: DecodeText
    - class: DumpBeams
      params:
        file: ${PRED_DIR}/beams.npz" \
  --model_dir $MODEL_DIR \
  --model_params "
    inference.beam_search.beam_width: 12" \
  --input_pipeline "
    class: ParallelTextInputPipeline
    params:
      source_files:
        - $DEV_SOURCES" \
  > ${PRED_DIR}/predictions.txt


./seq2seq/bin/tools/multi-bleu.perl ${DEV_TARGETS_REF} < ${PRED_DIR}/predictions.txt
